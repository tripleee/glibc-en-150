#!/bin/sh

set -eu

log=$(mktemp -t travismake.XXXXXXXXXXXX)
trap 'tail -n 500 "$log" /dev/null; rm -f "$log"' EXIT
trap 'exit 126' HUP INT TERM

make "$@" >"$log" 2>&1 &
makeproc=$!

while true; do date +%T; sleep 300; done &
dateproc=$!

######## TODO: really kill if there is no progress at all for a very long time
tail -f "$log" | awk '! NR % 75 { print strftime("%T"), $0 }' &
logproc=$!

wait "$makeproc"
e=$?

kill "$dateproc" "$logproc"

exit "$e"
